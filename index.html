<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>üéâ Festa do Rafael - 22 Nov 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&family=Playfair+Display:wght@700;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <meta name="color-scheme" content="dark light">
    <style>
        /* ---------- Reset & Base ---------- */
        *,*::before,*::after{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family:"Poppins",sans-serif;
            background:#000;
            color:#fff;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            overflow-x:hidden;
            min-height:100vh;
            position:relative;
        }

        /* Respect user's reduced-motion preference */
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
        }

        /* ---------- Loading Screen ---------- */
        .loading-screen{
            position:fixed; inset:0;
            display:flex; align-items:center; justify-content:center; flex-direction:column;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            z-index:10000; color:#fff; padding:20px; text-align:center;
            animation:fadeOut 0.9s ease-out 1.2s forwards;
        }
        @keyframes fadeOut { to { opacity:0; pointer-events:none } }
        .loading-gift{font-size:3.2rem; margin-bottom:10px}
        .loading-text{font-weight:600;font-size:0.95rem}

        /* ---------- Background layers (light on mobile) ---------- */
        .animated-bg{ position:fixed; inset:0; z-index:1;
            background: linear-gradient(45deg,#667eea,#764ba2,#f093fb,#4facfe,#667eea);
            background-size:300% 300%;
            animation:gradientShift 20s linear infinite; opacity:0.9; filter:blur(0.6px)
        }
        @keyframes gradientShift { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }

        .particles,.stars,.light-waves{ position:fixed; inset:0; pointer-events:none; z-index:2; }
        .particle,.star{ position:absolute; border-radius:50%; filter:blur(0.6px); opacity:0.9 }

        /* ---------- Container ---------- */
        .container{ position:relative; z-index:10; max-width:980px; margin:0 auto; padding:18px; }

        /* ---------- Envelope ---------- */
        .envelope-container{ text-align:center; padding:28px 12px 8px; }
        .envelope{
            display:inline-block; font-size:3.4rem; cursor:pointer;
            filter:drop-shadow(0 12px 22px rgba(0,0,0,0.35));
            border-radius:12px;padding:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
            transition:transform .3s ease;
        }
        .envelope:focus{ outline:3px solid rgba(255,255,255,0.12) }
        .envelope.opened{ animation:envelopeOpen .8s cubic-bezier(.34,1.56,.64,1) forwards }
        @keyframes envelopeOpen { 0%{transform:scale(1)} 50%{transform:scale(1.18) rotate(260deg)} 100%{transform:scale(0);opacity:0} }
        .envelope-hint{ color:rgba(255,255,255,0.95); margin-top:10px; font-weight:600; font-size:0.95rem }

        /* ---------- Hero ---------- */
        .hero{ text-align:center; padding:18px 8px 10px; opacity:0; transform:scale(.98); transition:all .5s cubic-bezier(.34,1.56,.64,1) }
        .hero.revealed{ opacity:1; transform:scale(1) }
        .hero-emoji{ font-size:4.8rem; display:inline-block; margin:14px 0; cursor:pointer; filter:drop-shadow(0 12px 30px rgba(255,255,255,0.12)) }
        .hero-title{ font-family:'Playfair Display',serif; font-size:2rem; font-weight:900; margin:12px 0 6px; letter-spacing:1.5px; background:linear-gradient(135deg,#fff,#f0f0f0); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 0 24px rgba(255,255,255,0.06) }
        .hero-subtitle{ font-family:'Dancing Script',cursive; font-size:1.1rem; margin-bottom:6px; color:rgba(255,255,255,0.95) }
        .hero-date{ font-size:.95rem; color:rgba(255,255,255,0.9); font-weight:600; letter-spacing:2px }

        /* ---------- Event Card ---------- */
        .event-card{
            background:rgba(255,255,255,0.06);
            backdrop-filter: blur(8px);
            border-radius:18px; padding:28px 18px; margin:20px auto;
            border:1px solid rgba(255,255,255,0.12);
            box-shadow:0 18px 50px rgba(0,0,0,0.45);
            position:relative; overflow:hidden; transition:transform .45s ease,opacity .45s ease;
            opacity:0; transform:translateY(24px);
        }
        .event-card.revealed{ opacity:1; transform:translateY(0) }

        .event-title{ font-family:'Playfair Display',serif; font-size:1.4rem; text-align:center; margin-bottom:18px; font-weight:900 }

        .event-details{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px }
        .detail-item{ text-align:center; padding:14px; border-radius:12px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06) }
        .detail-icon{ font-size:1.5rem; margin-bottom:8px; display:block }
        .detail-label{ font-size:.75rem; color:rgba(255,255,255,0.8); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; font-weight:700 }
        .detail-value{ font-size:.95rem; font-weight:700; color:#fff; line-height:1.2 }

        /* ---------- RSVP Section ---------- */
        .rsvp-section{
            background:rgba(255,255,255,0.96); color:#111; border-radius:16px; padding:20px; margin:18px auto;
            box-shadow:0 20px 60px rgba(0,0,0,0.25);
            transition:transform .45s ease,opacity .45s ease; opacity:0; transform:translateY(30px);
        }
        .rsvp-section.revealed{ opacity:1; transform:translateY(0) }

        .progress-container{ margin-bottom:16px }
        .progress-steps{ display:flex; gap:8px; align-items:center; justify-content:space-between; position:relative; padding:0 8px }
        .progress-step{ text-align:center; flex:1; position:relative }
        .step-circle{ width:40px; height:40px; border-radius:50%; background:#e5e7eb; border:3px solid #fff; display:flex; align-items:center; justify-content:center; font-weight:700; color:#999; margin:0 auto 6px }
        .step-circle.active{ background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; transform:scale(1.12); box-shadow:0 10px 20px rgba(102,126,234,0.25) }
        .step-label{ font-size:.75rem; color:#666; font-weight:700 }
        .progress-line{ position:absolute; left:10%; right:10%; top:20px; height:6px; background:#eee; border-radius:6px; z-index:0 }
        .progress-line-fill{ height:100%; background:linear-gradient(90deg,#667eea,#764ba2); width:0%; border-radius:6px; transition:width .45s ease }

        /* ---------- Form Steps & Controls ---------- */
        .form-step{ display:none; animation:stepSlide .45s ease }
        .form-step.active{ display:block }
        @keyframes stepSlide{ from{opacity:0; transform:translateX(20px)} to{opacity:1; transform:translateX(0)} }

        .step-header{text-align:center; margin-bottom:14px}
        .step-number{ display:inline-flex; width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; align-items:center; justify-content:center; font-weight:700; margin-bottom:8px }
        .step-title{ font-size:1.25rem; color:#111; margin-bottom:6px; font-weight:800 }
        .step-subtitle{ font-size:.95rem; color:#4b5563 }

        .form-group{ margin-bottom:12px }
        .form-label{ font-size:.95rem; font-weight:700; color:#374151; margin-bottom:8px; display:flex; gap:8px; align-items:center }
        .form-control{ width:100%; padding:12px 14px; border-radius:12px; border:2px solid #e5e7eb; font-size:1rem; background:#fff; color:#111; font-weight:600; box-shadow:none }
        textarea.form-control{ min-height:110px; resize:vertical }

        .radio-options{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
        .radio-option{ position:relative }
        .radio-option input[type="radio"]{ position:absolute; opacity:0; pointer-events:none }
        .radio-label{ display:flex; flex-direction:column; gap:6px; align-items:center; padding:12px; border-radius:12px; background:#f8fafb; border:2px solid #e5e7eb; cursor:pointer; text-align:center; transition:transform .25s ease }
        .radio-label .radio-emoji{ font-size:1.8rem }
        .radio-label .radio-text{ font-weight:800 }
        .radio-label .radio-subtext{ font-size:.85rem; color:#6b7280 }

        .radio-option input[type="radio"]:checked + .radio-label{ background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; transform:scale(1.03); box-shadow:0 12px 30px rgba(102,126,234,0.18) }

        /* ---------- Buttons ---------- */
        .form-navigation{ display:flex; gap:10px; margin-top:12px }
        .btn{ flex:1; padding:12px 14px; border-radius:12px; font-weight:800; cursor:pointer; border:none; font-size:1rem }
        .btn-primary{ background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; box-shadow:0 10px 30px rgba(102,126,234,0.18) }
        .btn-secondary{ background:#fff; color:#667eea; border:2px solid #667eea }
        .btn:disabled{ opacity:.6; cursor:not-allowed }

        /* ---------- Success ---------- */
        .success-screen{ display:none; text-align:center; padding:18px }
        .success-emoji{ font-size:3.2rem; margin-bottom:8px }
        .success-title{ font-family:'Playfair Display',serif; font-size:1.4rem; color:#111; margin-bottom:8px }
        .success-message{ font-size:1rem; color:#374151; margin-bottom:10px }
        .success-info{ background:linear-gradient(135deg,#d4edda,#c3e6cb); padding:12px; border-radius:10px; color:#155724 }

        /* ---------- Floating little decorations (reduced size) ---------- */
        .floating-balloon{ position:fixed; font-size:2.2rem; z-index:5; transition:transform .4s ease; filter:drop-shadow(0 8px 18px rgba(0,0,0,0.28)) }

        /* ---------- Responsive ---------- */
        @media (max-width:768px){
            .hero-emoji{ font-size:3.6rem }
            .envelope{ font-size:3rem }
            .container{ padding:14px }
            .event-card{ padding:18px; border-radius:14px }
            .rsvp-section{ padding:16px; border-radius:14px }
            .radio-options{ grid-template-columns:1fr }
            .form-navigation{ flex-direction:column }
            .progress-steps{ gap:6px }
            .progress-line{ left:8%; right:8%; top:18px }
            .event-details{ grid-template-columns:1fr 1fr }
        }
        @media (max-width:420px){
            .hero-title{ font-size:1.4rem }
            .event-details{ grid-template-columns:1fr }
            .detail-item{ padding:12px }
            .step-title{ font-size:1.05rem }
            .loading-gift{ font-size:2.6rem }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen" aria-hidden="false">
        <div class="loading-gift" aria-hidden="true">üéÅ</div>
        <div class="loading-text">Preparando algo especial...</div>
    </div>

    <!-- Background -->
    <div class="animated-bg" aria-hidden="true"></div>
    <div class="particles" id="particles" aria-hidden="true"></div>
    <div class="light-waves" aria-hidden="true"><div class="wave"></div><div class="wave" style="animation-delay:1.6s"></div></div>
    <div class="stars" id="stars" aria-hidden="true"></div>

    <!-- Floating balloons -->
    <div class="floating-balloon" style="top:8%; left:6%;" onclick="popBalloon(this)" aria-hidden="true">üéà</div>
    <div class="floating-balloon" style="top:16%; right:8%;" onclick="popBalloon(this)" aria-hidden="true">üéà</div>

    <main class="container" id="mainContainer">
        <!-- Envelope -->
        <section class="envelope-container" id="envelopeContainer" aria-label="Convite">
            <button id="envelope" class="envelope" onclick="openEnvelope()" aria-expanded="false" aria-controls="hero">‚úâÔ∏è</button>
            <div class="envelope-hint">Clica no envelope para abrir o convite!</div>
        </section>

        <!-- Hero -->
        <section id="hero" class="hero" aria-hidden="true">
            <div class="hero-emoji" id="heroEmoji" onclick="triggerFireworks()" role="img" aria-label="Bolo de anivers√°rio">üéÇ</div>
            <h1 class="hero-title">Foste Convidado!</h1>
            <p class="hero-subtitle">Uma Celebra√ß√£o Inesquec√≠vel</p>
            <p class="hero-date">22 de Novembro, 2025</p>
        </section>

        <!-- Event Card -->
        <section id="eventCard" class="event-card" aria-labelledby="detalhesTitulo">
            <h2 id="detalhesTitulo" class="event-title">üéä Detalhes da Festa üéä</h2>
            <div class="event-details" role="list">
                <div class="detail-item" role="listitem">
                    <span class="detail-icon" aria-hidden="true">üéâ</span>
                    <div class="detail-label">Celebra√ß√£o</div>
                    <div class="detail-value">XV Anivers√°rio<br>do Rafael</div>
                </div>
                <div class="detail-item" role="listitem">
                    <span class="detail-icon" aria-hidden="true">üìÖ</span>
                    <div class="detail-label">Data</div>
                    <div class="detail-value">22 de Novembro<br>2025</div>
                </div>
                <div class="detail-item" role="listitem">
                    <span class="detail-icon" aria-hidden="true">üïê</span>
                    <div class="detail-label">Hor√°rio</div>
                    <div class="detail-value">16:00 √†s 19:30</div>
                </div>
                <div class="detail-item" role="listitem">
                    <span class="detail-icon" aria-hidden="true">üìç</span>
                    <div class="detail-label">Local</div>
                    <div class="detail-value">
                        <a href="https://maps.app.goo.gl/uFFTRa8Vf1t7YGLn9" target="_blank" rel="noopener noreferrer" style="color:inherit; text-decoration:underline">GD Recreativo Cultural da Chesol</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- RSVP -->
        <section id="rsvpSection" class="rsvp-section" aria-live="polite" aria-labelledby="rsvpTitulo">
            <h2 id="rsvpTitulo" class="sr-only" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden">Formul√°rio RSVP</h2>

            <div class="progress-container" aria-hidden="true">
                <div class="progress-steps" role="list">
                    <div class="progress-step active" data-step="1">
                        <div class="step-circle active" id="circle1">1</div>
                        <div class="step-label">Identifica√ß√£o</div>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-circle" id="circle2">2</div>
                        <div class="step-label">Confirma√ß√£o</div>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-circle" id="circle3">3</div>
                        <div class="step-label">M√∫sica</div>
                    </div>
                    <div class="progress-step" data-step="4">
                        <div class="step-circle" id="circle4">4</div>
                        <div class="step-label">Mensagem</div>
                    </div>
                    <div class="progress-line" aria-hidden="true">
                        <div class="progress-line-fill" id="progressLineFill" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <form id="rsvpForm" novalidate>
                <!-- Step 1 -->
                <div class="form-step active" data-step="1" aria-hidden="false">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h3 class="step-title">üëã Ol√°!</h3>
                        <p class="step-subtitle">Vamos come√ßar pelo b√°sico</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="name"><span aria-hidden="true">‚úçÔ∏è</span> Como te chamas?</label>
                        <input id="name" class="form-control" type="text" placeholder="Nome" required autocomplete="name" />
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="form-step" data-step="2" aria-hidden="true">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h3 class="step-title">üéä Vens √† Festa?</h3>
                        <p class="step-subtitle">A tua presen√ßa √© muito importante!</p>
                    </div>
                    <div class="radio-options" role="radiogroup" aria-label="Confirma presen√ßa">
                        <div class="radio-option">
                            <input type="radio" id="attending-yes" name="attending" value="yes" required>
                            <label class="radio-label" for="attending-yes" tabindex="0">
                                <span class="radio-emoji" aria-hidden="true">üéâ</span>
                                <span class="radio-text">Sim, vou!</span>
                                <span class="radio-subtext">Mal posso esperar</span>
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="attending-no" name="attending" value="no">
                            <label class="radio-label" for="attending-no" tabindex="0">
                                <span class="radio-emoji" aria-hidden="true">üò¢</span>
                                <span class="radio-text">N√£o posso</span>
                                <span class="radio-subtext">Infelizmente...</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="form-step" data-step="3" aria-hidden="true">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <h3 class="step-title">üéµ Playlist da Festa</h3>
                        <p class="step-subtitle">Que m√∫sica te faz cantar?</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="music"><span aria-hidden="true">üé§</span> Ajuda-nos a criar o ambiente perfeito!</label>
                        <input id="music" class="form-control" type="text" placeholder="Ex: Artista - Nome da M√∫sica" autocomplete="off" />
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="form-step" data-step="4" aria-hidden="true">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <h3 class="step-title">Deixa uma Mensagem</h3>
                        <p class="step-subtitle">Partilha uma mensagem com o aniversariante (opcional)</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="message"><span aria-hidden="true">‚úâÔ∏è</span> A tua mensagem especial</label>
                        <textarea id="message" class="form-control" placeholder="Escreve algo especial para o Rafael..." ></textarea>
                    </div>
                </div>

                <!-- Success -->
                <div class="success-screen" id="successScreen" aria-hidden="true">
                    <div class="success-emoji" id="successEmoji" aria-hidden="true">üéâ</div>
                    <h3 class="success-title" id="successTitle">Confirmado!</h3>
                    <p class="success-message" id="successMessage">A tua resposta foi registada com sucesso.<br>Mal podemos esperar para celebrar contigo!</p>
                    <div class="success-info" id="successInfo"><strong>‚úÖ Resposta Guardada</strong><p>Vemo-nos dia 22 de Novembro √†s 16:00!</p></div>
                </div>
            </form>

            <div class="form-navigation" id="formNav" aria-hidden="false">
                <button type="button" id="prevBtn" class="btn btn-secondary" onclick="prevStep()" style="display:none">‚Üê Anterior</button>
                <button type="button" id="nextBtn" class="btn btn-primary" onclick="nextStep()"><span id="nextBtnText">Continuar ‚Üí</span></button>
            </div>
        </section>
    </main>

    <!-- Firebase scripts (kept) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js" defer></script>

    <script>
    (function(){
        'use strict';

        /* ---------- Firebase config (kept) ---------- */
        const firebaseConfig = {
            apiKey: "AIzaSyDcEL7SrmAJUoh54qoHd6C3TQiHwOL5fIU",
            authDomain: "grupoarmindo.firebaseapp.com",
            projectId: "grupoarmindo",
            storageBucket: "grupoarmindo.firebasestorage.app",
            messagingSenderId: "122992601269",
            appId: "1:122992601269:web:6c5cc5fff438fc90dbb6fc",
            measurementId: "G-G10H46Y8VD"
        };

        // Initialize firebase only if available
        function initFirebaseSafely() {
            if (window.firebase && firebase.initializeApp && !firebase.apps.length) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    if (firebase.firestore) return firebase.firestore();
                } catch (err) {
                    console.warn('Erro ao inicializar Firebase:', err);
                }
            } else if (!window.firebase) {
                // firebase script not loaded yet (defer), try later if needed
                return null;
            } else if (firebase.apps.length) {
                try { return firebase.firestore(); } catch (e) { return null; }
            }
            return null;
        }

        // Try to initialize immediately (if scripts already parsed)
        let db = initFirebaseSafely();

        // Also attempt to initialize when window loads (scripts with defer will be available)
        window.addEventListener('load', function() {
            if (!db) db = initFirebaseSafely();
        });

        /* ---------- State ---------- */
        let currentStep = 1;
        const totalSteps = 4;
        let envelopeOpened = false;
        const mainContainer = document.getElementById('mainContainer');

        /* ---------- Utility helpers ---------- */
        const $ = sel => document.querySelector(sel);
        const $$ = sel => Array.from(document.querySelectorAll(sel));

        function safeGet(id) { return document.getElementById(id) || null; }

        /* ---------- Visual lightweight particles & stars ---------- */
        function createParticles(limit = 14) {
            const container = safeGet('particles');
            if (!container) return;
            const colors = ['#ff6b6b','#4ecdc4','#ffe66d','#a8e6cf','#ffd93d'];
            // reduce number on small devices
            const finalCount = Math.min(limit, Math.max(6, Math.floor(window.innerWidth / 40)));
            for (let i = 0; i < finalCount; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = (Math.random()*100) + '%';
                p.style.top = (Math.random()*100) + '%';
                const size = (Math.random()*6 + 2) + 'px';
                p.style.width = size; p.style.height = size;
                p.style.background = colors[Math.floor(Math.random()*colors.length)];
                p.style.opacity = (Math.random()*0.6 + 0.3).toString();
                container.appendChild(p);
            }
        }

        function createStars(limit = 60) {
            const container = safeGet('stars');
            if (!container) return;
            const finalCount = Math.min(limit, Math.max(10, Math.floor(window.innerWidth / 20)));
            for (let i = 0; i < finalCount; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.left = (Math.random()*100) + '%';
                s.style.top = (Math.random()*100) + '%';
                const size = (Math.random()*2 + 1) + 'px';
                s.style.width = size; s.style.height = size;
                s.style.background = 'white';
                s.style.opacity = (Math.random()*0.8 + 0.1).toString();
                container.appendChild(s);
            }
        }

        /* ---------- Envelope open flow ---------- */
        function openEnvelope() {
            if (envelopeOpened) return;
            envelopeOpened = true;
            const envelopeBtn = safeGet('envelope');
            const container = safeGet('envelopeContainer');
            if (!envelopeBtn || !container) return;
            envelopeBtn.classList.add('opened');
            envelopeBtn.setAttribute('aria-expanded','true');

            setTimeout(() => {
                // hide envelope and reveal main content progressively
                container.style.display = 'none';
                const hero = safeGet('hero');
                const eventCard = safeGet('eventCard');
                const rsvp = safeGet('rsvpSection');
                if (hero) { hero.classList.add('revealed'); hero.setAttribute('aria-hidden','false'); }
                if (eventCard) setTimeout(()=> { eventCard.classList.add('revealed'); }, 260);
                if (rsvp) setTimeout(()=> { rsvp.classList.add('revealed'); }, 560);
                triggerConfetti(100);
            }, 700);
        }

        /* ---------- Progress & Steps ---------- */
        function updateProgress() {
            const percent = ((currentStep - 1) / (totalSteps - 1)) * 100;
            const fill = safeGet('progressLineFill');
            if (fill) fill.style.width = percent + '%';
            for (let i = 1; i <= totalSteps; i++) {
                const circle = safeGet('circle' + i);
                const stepNode = document.querySelector('.progress-step[data-step="'+i+'"]');
                if (!circle || !stepNode) continue;
                if (i < currentStep) {
                    circle.classList.add('completed'); circle.classList.remove('active'); circle.textContent = '‚úì';
                    stepNode.classList.remove('active');
                } else if (i === currentStep) {
                    circle.classList.add('active'); circle.classList.remove('completed'); circle.textContent = i;
                    stepNode.classList.add('active');
                } else {
                    circle.classList.remove('active','completed'); circle.textContent = i;
                    stepNode.classList.remove('active');
                }
            }
        }

        function showStep(step) {
            $$('.form-step').forEach(s => {
                s.classList.remove('active'); s.setAttribute('aria-hidden','true');
            });
            const node = document.querySelector('.form-step[data-step="'+step+'"]');
            if (node) {
                node.classList.add('active'); node.setAttribute('aria-hidden','false');
                // ensure input is focused on small screens
                const firstInput = node.querySelector('input, textarea, select, [tabindex]');
                if (firstInput) {
                    setTimeout(()=> { try { firstInput.focus({preventScroll:true}); } catch(e){} }, 200);
                }
            }
        }

        function validateStep() {
            const node = document.querySelector('.form-step[data-step="'+currentStep+'"]');
            if (!node) return true;
            const requiredInputs = node.querySelectorAll('input[required], textarea[required]');
            for (const input of requiredInputs) {
                if (input.type === 'radio') {
                    const groupChecked = node.querySelector('input[name="'+input.name+'"]:checked');
                    if (!groupChecked) { // focus first visible option
                        const firstLabel = node.querySelector('.radio-label');
                        if (firstLabel) firstLabel.focus();
                        return false;
                    }
                } else if (!input.value || !input.value.trim()) {
                    input.focus();
                    return false;
                }
            }
            return true;
        }

        function updateButtons() {
            const prev = safeGet('prevBtn'), nextTxt = safeGet('nextBtnText');
            if (prev) prev.style.display = (currentStep === 1) ? 'none' : 'block';
            if (nextTxt) nextTxt.innerHTML = (currentStep === totalSteps) ? 'üéâ Confirmar' : 'Continuar ‚Üí';
        }

        function nextStep() {
            if (!validateStep()) return;
            // shortcut: if on step 2 and chose 'no', jump to message (step 4)
            if (currentStep === 2) {
                const attendingNo = !!safeGet('attending-no') && safeGet('attending-no').checked;
                if (attendingNo) {
                    currentStep = 4;
                    // customize message step for non-attending
                    const titleNode = document.querySelector('.form-step[data-step="4"] .step-title');
                    const subtitleNode = document.querySelector('.form-step[data-step="4"] .step-subtitle');
                    if (titleNode) titleNode.textContent = 'üò¢ Vais fazer falta!';
                    if (subtitleNode) subtitleNode.textContent = 'Deixa-nos saber porqu√™ (opcional)';
                    showStep(currentStep); updateProgress(); updateButtons(); return;
                }
            }
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep); updateProgress(); updateButtons();
            } else {
                submitForm();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                const attendingNo = !!safeGet('attending-no') && safeGet('attending-no').checked;
                if (currentStep === 4 && attendingNo) {
                    currentStep = 2;
                    // restore standard text
                    const titleNode = document.querySelector('.form-step[data-step="4"] .step-title');
                    const subtitleNode = document.querySelector('.form-step[data-step="4"] .step-subtitle');
                    if (titleNode) titleNode.textContent = 'Deixa uma Mensagem';
                    if (subtitleNode) subtitleNode.textContent = 'Partilha uma mensagem com o aniversariante (opcional)';
                } else {
                    currentStep--;
                }
                showStep(currentStep); updateProgress(); updateButtons();
            }
        }

        /* ---------- Form Submit ---------- */
        function submitForm() {
            const nameEl = safeGet('name');
            const attendingEl = document.querySelector('input[name="attending"]:checked');
            const musicEl = safeGet('music');
            const messageEl = safeGet('message');
            const nextBtn = safeGet('nextBtn');

            const payload = {
                name: nameEl ? (nameEl.value || '').trim() : '',
                attending: attendingEl ? attendingEl.value : '',
                music: musicEl ? (musicEl.value || '').trim() : '',
                message: messageEl ? (messageEl.value || '').trim() : '',
                timestamp: (db && firebase && firebase.firestore) ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString()
            };

            if (nextBtn) { nextBtn.disabled = true; nextBtn.innerText = 'A enviar...'; }

            if (!db) {
                // No firestore available: simulate success (keeps UI working offline)
                console.info('Firestore indispon√≠vel ‚Äî simulando envio', payload);
                setTimeout(()=> {
                    showSuccess(payload.attending || 'yes');
                }, 700);
                return;
            }

            try {
                db.collection('guests').add(payload).then(() => {
                    showSuccess(payload.attending || 'yes');
                }).catch(err => {
                    console.error('Erro ao enviar para Firestore:', err);
                    alert('Erro ao enviar. Tenta novamente mais tarde.');
                    if (nextBtn) { nextBtn.disabled = false; updateButtons(); }
                });
            } catch (err) {
                console.error('Erro inesperado ao enviar:', err);
                alert('Erro inesperado. Confere a consola.');
                if (nextBtn) { nextBtn.disabled = false; updateButtons(); }
            }
        }

        function showSuccess(attending = 'yes') {
            // hide form steps & navigation
            $$('.form-step').forEach(s => { s.style.display = 'none'; });
            const formNav = safeGet('formNav'); if (formNav) formNav.style.display = 'none';

            const successScreen = safeGet('successScreen');
            const emoji = safeGet('successEmoji');
            const title = safeGet('successTitle');
            const msg = safeGet('successMessage');
            const info = safeGet('successInfo');

            if (attending === 'no') {
                if (emoji) emoji.textContent = 'üò¢';
                if (title) title.textContent = 'Que Pena...';
                if (msg) msg.innerHTML = 'Vais fazer muita falta na festa.<br>Obrigado por responderes.';
                if (info) info.innerHTML = '<strong>üíî Obrigado</strong><p>Fica bem!</p>';
            } else {
                if (emoji) emoji.textContent = 'üéâ';
                if (title) title.textContent = 'Confirmado!';
                if (msg) msg.innerHTML = 'A tua resposta foi registada com sucesso.<br>Mal podemos esperar para celebrar contigo!';
                if (info) info.innerHTML = '<strong>‚úÖ Resposta Guardada</strong><p>Vemo-nos dia 22 de Novembro √†s 16:00!</p>';
                // celebratory effects
                triggerConfetti(140);
                setTimeout(()=> triggerFireworks(), 700);
            }
            if (successScreen) { successScreen.style.display = 'block'; successScreen.setAttribute('aria-hidden','false'); }
            // scroll into view for small screens
            setTimeout(()=> { try { mainContainer.scrollIntoView({behavior:'smooth'}); } catch(e){} }, 100);
        }

        /* ---------- Visual effects (lighter & safe) ---------- */
        function triggerConfetti(count = 80) {
            // lightweight confetti using fixed elements + CSS transforms
            for (let i = 0; i < count; i++) {
                setTimeout(()=> {
                    const conf = document.createElement('div');
                    conf.className = 'confetti-piece';
                    conf.style.position = 'fixed';
                    conf.style.left = Math.random() * window.innerWidth + 'px';
                    conf.style.top = '-10px';
                    const size = (Math.random()*10 + 6) + 'px';
                    conf.style.width = size; conf.style.height = size;
                    conf.style.background = ['#ff6b6b','#4ecdc4','#ffe66d','#a8e6cf','#ffd93d'][Math.floor(Math.random()*5)];
                    if (Math.random() > 0.5) conf.style.borderRadius = '50%';
                    conf.style.zIndex = 9999;
                    conf.style.transition = 'transform 3.2s linear, opacity 3.2s linear';
                    document.body.appendChild(conf);
                    requestAnimationFrame(()=> {
                        conf.style.transform = 'translateY(' + (window.innerHeight + 200) + 'px) rotate(' + (Math.random()*720) + 'deg)';
                        conf.style.opacity = '0';
                    });
                    setTimeout(()=> { try { conf.remove(); } catch(e){} }, 3500);
                }, i * 10);
            }
        }

        function triggerFireworks() {
            for (let i = 0; i < 6; i++) {
                setTimeout(()=> {
                    const el = document.createElement('div');
                    el.style.position = 'fixed';
                    el.style.left = (Math.random() * window.innerWidth) + 'px';
                    el.style.top = (Math.random() * (window.innerHeight * 0.4)) + 'px';
                    el.style.width = '6px'; el.style.height = '6px'; el.style.borderRadius = '50%';
                    el.style.background = ['#ff6b6b','#ffd93d','#4ecdc4'][Math.floor(Math.random()*3)];
                    el.style.zIndex = 9998; el.style.opacity = '0.95';
                    document.body.appendChild(el);
                    el.animate([{ transform: 'scale(0)', opacity: 1 }, { transform: 'scale(6)', opacity: 0 }], { duration: 900, easing: 'ease-out' });
                    setTimeout(()=> { try { el.remove(); } catch(e){} }, 950);
                }, i * 140);
            }
        }

        function createFirework(x,y,color='#ff6b6b') {
            for (let i=0;i<12;i++){
                const p = document.createElement('div');
                p.style.position='fixed';
                p.style.left = x + 'px'; p.style.top = y + 'px';
                const sz = (Math.random()*6 + 4) + 'px';
                p.style.width = sz; p.style.height = sz; p.style.borderRadius='50%';
                p.style.background = color; p.style.zIndex = 9999;
                document.body.appendChild(p);
                const angle = Math.random()*Math.PI*2;
                const dist = 40 + Math.random()*110;
                const tx = Math.cos(angle)*dist; const ty = Math.sin(angle)*dist;
                p.animate([{transform:'translate(0,0)', opacity:1},{transform:'translate('+tx+'px,'+ty+'px)', opacity:0}], {duration:900, easing:'cubic-bezier(.2,.8,.2,1)'});
                setTimeout(()=> { try { p.remove(); } catch(e){} }, 920);
            }
        }

        function popBalloon(balloon) {
            if (!balloon) return;
            balloon.style.transition = 'transform .25s ease, opacity .25s ease';
            balloon.style.transform = 'scale(0)'; balloon.style.opacity = '0';
            const rect = balloon.getBoundingClientRect();
            const x = rect.left + rect.width/2; const y = rect.top + rect.height/2;
            createFirework(x,y,'#ff6b6b');
            setTimeout(()=> { balloon.style.transform = 'scale(1)'; balloon.style.opacity = '1'; }, 2400);
        }

        /* ---------- Keyboard & Accessibility shortcuts ---------- */
        document.addEventListener('keydown', function(e) {
            // allow opening envelope with Enter/Space when focused
            const active = document.activeElement;
            if (!envelopeOpened && (e.key === 'Enter' || e.key === ' ')) {
                // If envelope button is focused or no focus, open
                const env = safeGet('envelope');
                if (env && (env === active || document.activeElement === document.body)) {
                    e.preventDefault();
                    openEnvelope();
                    return;
                }
            }

            // navigation when form visible
            const successVisible = safeGet('successScreen') && safeGet('successScreen').style.display === 'block';
            if (envelopeOpened && !successVisible) {
                if (e.key === 'Enter' && !e.target.matches('textarea')) {
                    e.preventDefault(); nextStep();
                } else if (e.key === 'ArrowRight') {
                    nextStep();
                } else if (e.key === 'ArrowLeft') {
                    prevStep();
                }
            }

            // small easter eggs (non-intrusive)
            if (e.key.toLowerCase() === 'c' && !e.target.matches('input, textarea')) triggerConfetti(60);
            if (e.key.toLowerCase() === 'f' && !e.target.matches('input, textarea')) triggerFireworks();
        });

        /* ---------- Auto-open envelope after a short delay,
           but only if user hasn't interacted (minimizes surprise on mobile) ---------- */
        let userInteracted = false;
        ['touchstart','pointerdown','mousemove','keydown'].forEach(ev => {
            window.addEventListener(ev, () => { userInteracted = true; }, { once: true, passive:true });
        });

        setTimeout(()=> {
            if (!envelopeOpened && !userInteracted) {
                openEnvelope();
            }
        }, 4200);

        /* ---------- Initialization ---------- */
        document.addEventListener('DOMContentLoaded', function() {
            // create visuals (lightweight)
            createParticles();
            createStars();
            updateProgress();
            updateButtons();
            // hide loading screen after short delay (ensures CSS animations complete)
            setTimeout(()=> {
                const ld = safeGet('loadingScreen'); if (ld) ld.style.display = 'none';
            }, 1200);

            // friendly mobile focus behavior
            $$('.form-control').forEach(input => {
                input.addEventListener('focus', ()=> {
                    setTimeout(()=> {
                        try { input.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){}
                    }, 220);
                });
            });

            // make radio labels keyboard-accessible (activate when pressing Enter/Space)
            $$('.radio-label').forEach(label => {
                label.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter' || ev.key === ' ') {
                        ev.preventDefault();
                        const id = label.getAttribute('for');
                        if (id) {
                            const el = document.getElementById(id);
                            if (el) el.checked = true;
                        }
                        label.click();
                    }
                });
            });

            // ensure Firebase initialisation if deferred scripts have loaded
            setTimeout(()=> { if (!db) db = initFirebaseSafely(); }, 900);
        });

        /* expose small functions globally for button onClick attributes */
        window.openEnvelope = openEnvelope;
        window.nextStep = nextStep;
        window.prevStep = prevStep;
        window.triggerConfetti = triggerConfetti;
        window.triggerFireworks = triggerFireworks;
        window.popBalloon = popBalloon;

    })();
    </script>
</body>
</html>
