<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üéâ Festa do Rafael - 22 Nov 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&family=Playfair+Display:wght@700;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
<style>
/* ==========================
   Reset & base
   ========================== */
:root{
  --bg-1:#0b0221;
  --glass: rgba(255,255,255,0.08);
  --accent1: #667eea;
  --accent2: #764ba2;
  --white: #fff;
  --muted: #9ca3af;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family: 'Poppins',sans-serif;
  background: var(--bg-1);
  color:var(--white);
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  min-height:100vh;
  position:relative;
  padding-bottom:40px;
}

/* ==========================
   Loading overlay (removed after init)
   ========================== */
.loading-screen{
  position:fixed;inset:0;z-index:9999;
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  gap:18px;
  transition:opacity .6s ease,visibility .3s ease;
  font-weight:700;
}
.loading-screen.hidden{opacity:0;visibility:hidden;pointer-events:none}
.loading-gift{font-size:4.5rem;animation:giftShake 1s infinite}
@keyframes giftShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-8deg)}75%{transform:rotate(8deg)}}
.loading-text{color:#fff;font-size:1.05rem;letter-spacing:.2px}

/* ==========================
   Animated background (gradient)
   ========================== */
.animated-bg{
  position:fixed;inset:0;z-index:0;
  background:linear-gradient(45deg,#0f0624 0%,#1a0a2e 20%, #2a0f3f 50%, #1a3a6a 100%);
  background-size:400% 400%;animation:gradientShift 18s linear infinite;filter:blur(12px) saturate(120%);
  opacity:.95;
}
@keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}

/* ==========================
   Part√≠culas & estrelas (fewer by default)
   ========================== */
.particles, .stars{position:fixed;inset:0;pointer-events:none;z-index:1}
.particle{
  position:absolute;border-radius:50%;
  filter:blur(.6px);opacity:.95;
  transform:translate3d(0,0,0);
  will-change:transform,opacity;
}
.star{position:absolute;background:linear-gradient(180deg,#fff,#ffe);border-radius:50%;filter:drop-shadow(0 0 6px rgba(255,255,255,.6));will-change:opacity,transform}

/* ==========================
   Floating elements (balloons)
   ========================== */
.floating-balloon{
  position:fixed;font-size:3.2rem;z-index:6;cursor:pointer;
  transform-origin:center center;transition:transform .25s ease;filter:drop-shadow(0 8px 20px rgba(0,0,0,.45));
}
.floating-balloon:active{transform:scale(.9)}

/* ==========================
   Container & hero
   ========================== */
.container{position:relative;z-index:10;max-width:960px;margin:0 auto;padding:20px}
.envelope-container{ text-align:center;padding:28px 10px 8px; }
.envelope{font-size:5.2rem;display:inline-block;cursor:pointer;filter:drop-shadow(0 18px 35px rgba(0,0,0,.35));transition:transform .45s cubic-bezier(.2,.9,.3,1)}
.envelope:hover{transform:scale(1.08) rotate(6deg)}
.envelope.opened{animation:envelopeOpen .9s cubic-bezier(.22,.8,.34,1) forwards}
@keyframes envelopeOpen{0%{transform:scale(1)}60%{transform:scale(1.25) rotate(14deg)}100%{transform:scale(0);opacity:0}}

.envelope-hint{margin-top:10px;color:rgba(255,255,255,.9);font-weight:600}

/* hero */
.hero{text-align:center;padding:18px 10px 26px;opacity:0;transform:scale(.98);transition:all .8s cubic-bezier(.2,.9,.3,1)}
.hero.revealed{opacity:1;transform:scale(1)}
.hero-emoji{font-size:6.5rem;display:inline-block;cursor:pointer;margin:14px 0;filter:drop-shadow(0 12px 30px rgba(0,0,0,.4))}
.hero-title{font-family:'Playfair Display',serif;font-size:3.6rem;font-weight:900;letter-spacing:2px;margin:12px 0;background:linear-gradient(90deg,#fff,#f0f0f0);-webkit-background-clip:text;background-clip:text;color:transparent}
.hero-subtitle{font-family:'Dancing Script',cursive;font-size:1.6rem;margin-bottom:6px}
.hero-date{font-size:1rem;color:rgba(255,255,255,.9);letter-spacing:2px;font-weight:700}

/* ==========================
   Event card & RSVP (glass)
   ========================== */
.event-card{background:rgba(255,255,255,0.06);backdrop-filter:blur(10px);border-radius:24px;padding:34px;margin:22px auto;border:1px solid rgba(255,255,255,.06);box-shadow:0 30px 80px rgba(0,0,0,.5);transition:transform .6s ease,opacity .6s ease;opacity:0;transform:translateY(18px)}
.event-card.revealed{opacity:1;transform:none}
.event-title{text-align:center;font-family:'Playfair Display',serif;font-size:1.7rem;margin-bottom:18px}
.event-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px}
.detail-item{padding:18px;border-radius:14px;background:rgba(255,255,255,0.02);text-align:center;border:1px solid rgba(255,255,255,0.03);transition:transform .35s ease,box-shadow .35s ease}
.detail-item:hover{transform:translateY(-8px);box-shadow:0 18px 40px rgba(0,0,0,.36)}
.detail-icon{font-size:2rem;margin-bottom:8px;display:block}
.detail-label{font-size:.78rem;color:var(--muted);font-weight:700;letter-spacing:1.2px}
.detail-value{font-weight:700;margin-top:6px;line-height:1.2}

/* RSVP section */
.rsvp-section{background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.98));color:#111;border-radius:20px;padding:28px;margin:28px auto;max-width:920px;box-shadow:0 30px 80px rgba(0,0,0,.45);opacity:0;transform:translateY(20px);transition:opacity .7s ease,transform .7s ease}
.rsvp-section.revealed{opacity:1;transform:none}

/* progress */
.progress-container{margin-bottom:18px}
.progress-steps{display:flex;justify-content:space-between;align-items:center;gap:12px;position:relative;padding:8px 6px}
.progress-step{flex:1;text-align:center;position:relative;z-index:2}
.step-circle{width:44px;height:44px;border-radius:50%;background:#e5e7eb;border:3px solid #fff;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#999;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.step-circle.active{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;transform:scale(1.06);box-shadow:0 12px 30px rgba(102,126,234,.35)}
.step-circle.completed{background:#10b981;color:#fff}
.step-label{font-size:.85rem;color:#6b7280;font-weight:700}
.progress-line{position:absolute;top:22px;left:60px;right:60px;height:6px;background:rgba(0,0,0,.06);border-radius:6px;z-index:1}
.progress-line-fill{height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));width:0;border-radius:6px;transition:width .45s cubic-bezier(.2,.9,.3,1)}

/* form */
.form-step{display:none}
.form-step.active{display:block}
.step-header{text-align:center;margin-bottom:18px}
.step-number{display:inline-block;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;line-height:44px;font-weight:700;margin-bottom:10px}
.step-title{font-size:1.6rem;font-weight:800;color:#111;margin-bottom:6px}
.step-subtitle{font-size:.95rem;color:#374151}

/* controls */
.form-group{margin-bottom:18px}
.form-label{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-weight:700;color:#374151}
.form-control{width:100%;padding:14px 16px;border-radius:12px;border:2px solid #e5e7eb;font-size:1rem;font-weight:600;background:#fff;transition:box-shadow .25s ease,transform .25s ease}
.form-control:focus{outline:none;box-shadow:0 12px 30px rgba(102,126,234,.12);transform:translateY(-3px)}
textarea.form-control{min-height:120px;resize:vertical;line-height:1.5}

/* radios */
.radio-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.radio-option input{position:absolute;opacity:0}
.radio-label{display:flex;flex-direction:column;align-items:center;padding:18px;border-radius:12px;background:linear-gradient(180deg,#f9fafb,#f3f4f6);border:2px solid #e5e7eb;cursor:pointer;transition:transform .25s ease,box-shadow .25s ease}
.radio-option input:checked + .radio-label{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;transform:scale(1.03);box-shadow:0 18px 45px rgba(102,126,234,.28)}
.radio-emoji{font-size:2.4rem;margin-bottom:10px}
.radio-text{font-weight:800}
.radio-subtext{font-size:.85rem;margin-top:6px;opacity:.95}

/* nav buttons */
.form-navigation{display:flex;gap:14px;margin-top:18px}
.btn{flex:1;padding:14px 20px;border-radius:12px;border:none;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden}
.btn:disabled{opacity:.65;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;box-shadow:0 18px 45px rgba(102,126,234,.25)}
.btn-secondary{background:#fff;color:var(--accent1);border:2px solid var(--accent1)}
.btn .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.25);border-top-color:rgba(255,255,255,.95);border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
@keyframes spin{100%{transform:rotate(360deg)}}

/* success screen */
.success-screen{display:none;text-align:center;padding:28px}
.success-screen.show{display:block}
.success-emoji{font-size:6rem;display:inline-block;margin-bottom:12px}
.success-title{font-family:'Playfair Display',serif;font-size:2.1rem;margin:12px 0 6px;color:#111}
.success-message{color:#374151;font-size:1rem;margin-bottom:12px}
.success-info{background:linear-gradient(135deg,#d4edda,#c3e6cb);padding:14px;border-radius:10px;border-left:6px solid #28a745;color:#155724}

/* small screens */
@media (max-width:720px){
  .hero-title{font-size:2.2rem}
  .envelope{font-size:4rem}
  .hero-emoji{font-size:4.8rem}
  .event-card{padding:20px}
  .rsvp-section{padding:18px}
}

/* accessibility preference */
@media (prefers-reduced-motion:reduce){
  .animated-bg, .particle, .star, .hero-emoji, .envelope{animation:none;transition:none}
}
</style>
</head>
<body>
  <!-- Loading -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-gift">üéÅ</div>
    <div class="loading-text">Preparando magia... ‚ú®</div>
  </div>

  <!-- Background layers -->
  <div class="animated-bg" aria-hidden="true"></div>
  <div class="particles" id="particles" aria-hidden="true"></div>
  <div class="stars" id="stars" aria-hidden="true"></div>

  <!-- Floating balloons (few, interactive) -->
  <div class="floating-balloon" style="top:10%;left:6%;" onclick="popBalloon(this)">üéà</div>
  <div class="floating-balloon" style="top:22%;right:8%;animation-delay:-1s" onclick="popBalloon(this)">üéà</div>
  <div class="floating-balloon" style="bottom:20%;left:8%;animation-delay:-2s" onclick="popBalloon(this)">üéà</div>

  <div class="container" id="mainContainer">
    <div class="envelope-container" id="envelopeContainer" aria-hidden="false">
      <div class="envelope" id="envelope" title="Abrir convite" role="button" tabindex="0" aria-pressed="false" onclick="openEnvelope()" onkeydown="if(event.key==='Enter') openEnvelope()">‚úâÔ∏è</div>
      <div class="envelope-hint" id="envelopeHint">Clica no envelope para abrir o convite!</div>
    </div>

    <!-- Hero -->
    <div class="hero" id="hero" aria-live="polite" aria-atomic="true">
      <div class="hero-emoji" title="Dispara fogos" role="button" tabindex="0" onclick="triggerFireworks()" onkeydown="if(event.key==='Enter') triggerFireworks()">üéÇ</div>
      <h1 class="hero-title" id="heroTitle">Foste Convidado!</h1>
      <p class="hero-subtitle" id="heroSubtitle">Uma Celebra√ß√£o Inesquec√≠vel</p>
      <p class="hero-date">22 de Novembro, 2025</p>
    </div>

    <!-- Event Card -->
    <div class="event-card" id="eventCard" role="region" aria-labelledby="eventTitle">
      <h2 class="event-title" id="eventTitle">üéä Detalhes da Festa üéä</h2>
      <div class="event-details" id="eventDetails">
        <div class="detail-item">
          <span class="detail-icon">üéâ</span>
          <div class="detail-label">Celebra√ß√£o</div>
          <div class="detail-value">XV Anivers√°rio<br>do Rafael</div>
        </div>
        <div class="detail-item">
          <span class="detail-icon">üìÖ</span>
          <div class="detail-label">Data</div>
          <div class="detail-value">22 de Novembro<br>2025</div>
        </div>
        <div class="detail-item">
          <span class="detail-icon">üïê</span>
          <div class="detail-label">Hor√°rio</div>
          <div class="detail-value">16:00 ‚Äî 19:30</div>
        </div>
        <div class="detail-item">
          <span class="detail-icon">üìç</span>
          <div class="detail-label">Local</div>
          <div class="detail-value">
            <a href="https://maps.app.goo.gl/uFFTRa8Vf1t7YGLn9" target="_blank" rel="noopener" style="color:inherit;text-decoration:none">GD Recreativo<br>Cultural da Chesol</a>
          </div>
        </div>
      </div>
    </div>

    <!-- RSVP (lazy revealed) -->
    <div class="rsvp-section" id="rsvpSection" aria-live="polite" aria-atomic="true" role="form">
      <div class="progress-container" aria-hidden="true">
        <div class="progress-steps" id="progressSteps">
          <div class="progress-step" data-step="1">
            <div class="step-circle active" id="circle1">1</div>
            <div class="step-label">Identifica√ß√£o</div>
          </div>
          <div class="progress-step" data-step="2">
            <div class="step-circle" id="circle2">2</div>
            <div class="step-label">Confirma√ß√£o</div>
          </div>
          <div class="progress-step" data-step="3">
            <div class="step-circle" id="circle3">3</div>
            <div class="step-label">M√∫sica</div>
          </div>
          <div class="progress-step" data-step="4">
            <div class="step-circle" id="circle4">4</div>
            <div class="step-label">Mensagem</div>
          </div>
          <div class="progress-line" aria-hidden="true">
            <div class="progress-line-fill" id="progressLineFill" style="width:0%"></div>
          </div>
        </div>
      </div>

      <form id="rsvpForm" autocomplete="off" novalidate>
        <!-- Step 1 -->
        <div class="form-step active" data-step="1">
          <div class="step-header">
            <div class="step-number">1</div>
            <h3 class="step-title">üëã Ol√°!</h3>
            <p class="step-subtitle">Como te chamas?</p>
          </div>
          <div class="form-group">
            <label class="form-label" for="name"><span class="label-icon">‚úçÔ∏è</span>Nome</label>
            <input id="name" name="name" class="form-control" type="text" placeholder="Ex: Jo√£o" required aria-required="true" />
            <div class="inline-error" id="errorName" style="color:#bd2130;font-weight:700;margin-top:8px;display:none;font-size:.9rem"></div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="form-step" data-step="2">
          <div class="step-header">
            <div class="step-number">2</div>
            <h3 class="step-title">üéä Vens √† Festa?</h3>
            <p class="step-subtitle">A tua presen√ßa √© muito importante!</p>
          </div>
          <div class="radio-options" role="radiogroup" aria-required="true">
            <div class="radio-option">
              <input type="radio" id="attending-yes" name="attending" value="yes" required />
              <label class="radio-label" for="attending-yes">
                <span class="radio-emoji">üéâ</span>
                <span class="radio-text">Sim, vou!</span>
                <span class="radio-subtext">Mal posso esperar</span>
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" id="attending-no" name="attending" value="no" />
              <label class="radio-label" for="attending-no">
                <span class="radio-emoji">üò¢</span>
                <span class="radio-text">N√£o posso</span>
                <span class="radio-subtext">Infelizmente...</span>
              </label>
            </div>
          </div>
          <div class="inline-error" id="errorAttending" style="color:#bd2130;font-weight:700;margin-top:8px;display:none;font-size:.9rem"></div>
        </div>

        <!-- Step 3 -->
        <div class="form-step" data-step="3">
          <div class="step-header">
            <div class="step-number">3</div>
            <h3 class="step-title">üéµ Playlist da Festa</h3>
            <p class="step-subtitle">Sugere uma m√∫sica (opcional)</p>
          </div>
          <div class="form-group">
            <label class="form-label" for="music"><span class="label-icon">üé§</span>Artista - M√∫sica</label>
            <input id="music" name="music" class="form-control" placeholder="Ex: Adele - Rolling in the Deep" />
          </div>
        </div>

        <!-- Step 4 -->
        <div class="form-step" data-step="4">
          <div class="step-header">
            <div class="step-number">4</div>
            <h3 class="step-title" id="step4Title">üíå Deixa uma Mensagem</h3>
            <p class="step-subtitle" id="step4Subtitle">Partilha uma mensagem com o aniversariante (opcional)</p>
          </div>
          <div class="form-group">
            <label class="form-label" for="message"><span class="label-icon">‚úâÔ∏è</span>Mensagem</label>
            <textarea id="message" name="message" class="form-control" placeholder="Escreve algo especial para o Rafael..."></textarea>
          </div>
        </div>

        <!-- Success (inline, hidden) -->
        <div class="success-screen" id="successScreen" aria-hidden="true">
          <div class="success-animation">
            <div class="success-emoji" id="successEmoji">üéâ</div>
          </div>
          <h3 class="success-title" id="successTitle">Confirmado!</h3>
          <p class="success-message" id="successMessage">A tua resposta foi registada com sucesso. Mal podemos esperar para celebrar contigo!</p>
          <div class="success-info" id="successInfo"><strong>‚úÖ Resposta Guardada</strong><p>Vemo-nos dia 22 de Novembro √†s 16:00!</p></div>
        </div>
      </form>

      <!-- Navigation -->
      <div class="form-navigation" id="formNav">
        <button type="button" class="btn btn-secondary" id="prevBtn" onclick="prevStep()" style="display:none" aria-hidden="true">‚Üê Anterior</button>
        <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
          <span id="nextLabel">Continuar ‚Üí</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase (kept inline same as original but lazy-initialized only when needed) -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js" defer></script>

<script>
/* ==========================
   Script organizado, moderno e otimizado
   - Menos DOM no load
   - Lazy reveal do RSVP
   - requestAnimationFrame para part√≠culas animadas
   - Spinner no envio, valida√ß√£o inline
   - Sauda√ß√µes personalizadas
   ========================== */

/* ---------- Config ---------- */
const totalSteps = 4;
let currentStep = 1;
let envelopeOpened = false;
let particlesCount = Math.min(28, Math.floor(window.innerWidth / 40)); // mais leve em mobile
let starsCount = Math.min(90, Math.floor(window.innerWidth / 12));
const dbConfig = {
  apiKey: "AIzaSyDcEL7SrmAJUoh54qoHd6C3TQiHwOL5fIU",
  authDomain: "grupoarmindo.firebaseapp.com",
  projectId: "grupoarmindo",
  storageBucket: "grupoarmindo.firebasestorage.app",
  messagingSenderId: "122992601269",
  appId: "1:122992601269:web:6c5cc5fff438fc90dbb6fc",
  measurementId: "G-G10H46Y8VD"
};

/* ---------- Helpers ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

/* ---------- Lightweight particle system (requestAnimationFrame) ---------- */
function initParticles(){
  const container = $('#particles');
  if(!container) return;
  // create only if empty
  if(container.children.length) return;
  const colors = ['#ff6b6b','#4ecdc4','#ffe66d','#a8e6cf','#ffd93d','#ff8a80','#b39ddb'];
  for(let i=0;i<particlesCount;i++){
    const el = document.createElement('div');
    el.className='particle';
    const size = Math.random()*8 + 3;
    el.style.width = el.style.height = size + 'px';
    el.style.left = (Math.random()*100) + '%';
    el.style.top = (Math.random()*100) + '%';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el._vx = (Math.random()-0.5) * 0.08;
    el._vy = (Math.random()*-0.06) - 0.02;
    el._rot = Math.random()*360;
    el.style.opacity = .9;
    container.appendChild(el);
  }
  animateParticles();
}
let particleRAF;
function animateParticles(){
  const nodes = document.querySelectorAll('.particle');
  let last = performance.now();
  function step(now){
    const dt = Math.min(40, now - last);
    last = now;
    nodes.forEach(n => {
      let top = parseFloat(n.style.top);
      let left = parseFloat(n.style.left);
      top += (n._vy * dt * 0.06);
      left += (n._vx * dt * 0.06);
      if(top < -5) top = 105;
      if(left < -5) left = 105;
      if(left > 105) left = -5;
      n.style.top = top + '%';
      n.style.left = left + '%';
      n.style.transform = `rotate(${(n._rot += 0.02 * dt)}deg)`;
    });
    particleRAF = requestAnimationFrame(step);
  }
  if(!particleRAF) particleRAF = requestAnimationFrame(step);
}

/* ---------- Stars twinkle (CSS animation alternative) ---------- */
function initStars(){
  const container = $('#stars');
  if(!container) return;
  if(container.children.length) return;
  for(let i=0;i<starsCount;i++){
    const s = document.createElement('div');
    s.className='star';
    const size = Math.random()*3 + 1;
    s.style.width = s.style.height = size + 'px';
    s.style.left = Math.random()*100 + '%';
    s.style.top = Math.random()*100 + '%';
    s.style.animationDelay = (Math.random()*3) + 's';
    s.style.opacity = Math.random() < 0.6 ? 0.6 : 1;
    container.appendChild(s);
  }
}

/* ---------- Envelope open & reveal (lazy load RSVP) ---------- */
function openEnvelope(){
  if(envelopeOpened) return;
  envelopeOpened = true;
  const env = $('#envelope');
  env.classList.add('opened');
  env.setAttribute('aria-pressed','true');
  setTimeout(()=> {
    const container = $('#envelopeContainer');
    container.style.display = 'none';
    $('#hero').classList.add('revealed');
    setTimeout(()=> $('#eventCard').classList.add('revealed'), 400);
    // lazy reveal RSVP SECTION (and init particles/stars here for perf)
    setTimeout(()=> {
      initParticles();
      initStars();
      const rsvp = $('#rsvpSection');
      rsvp.classList.add('revealed');
      // focus first input
      const input = $('#name');
      if(input){ input.focus(); }
      // Init firebase only when needed
      initFirebase();
    }, 800);
    // celebratory
    triggerConfetti({count:40,burst:true});
  }, 700);
}

/* ---------- Progress UI ---------- */
function updateProgress(){
  const percent = ((currentStep-1)/(totalSteps-1))*100;
  $('#progressLineFill').style.width = percent + '%';
  for(let i=1;i<=totalSteps;i++){
    const circle = $(`#circle${i}`);
    const stepEl = document.querySelector(`.progress-step[data-step="${i}"]`);
    if(i < currentStep){
      circle.classList.add('completed'); circle.classList.remove('active'); circle.textContent='‚úì';
      stepEl.classList.remove('active');
    } else if(i === currentStep){
      circle.classList.add('active'); circle.classList.remove('completed'); circle.textContent = i;
      stepEl.classList.add('active');
    } else {
      circle.classList.remove('active','completed'); circle.textContent = i;
      stepEl.classList.remove('active');
    }
  }
}

/* ---------- Show / Hide steps ---------- */
function showStep(step){
  $$('.form-step').forEach(el => el.classList.remove('active'));
  const el = document.querySelector(`.form-step[data-step="${step}"]`);
  if(el) el.classList.add('active');
  // update buttons
  const prevBtn = $('#prevBtn'), nextBtn = $('#nextBtn'), nextLabel = $('#nextLabel');
  prevBtn.style.display = step === 1 ? 'none' : 'inline-flex';
  if(step === totalSteps){
    nextLabel.innerHTML = 'üéâ Confirmar';
  } else {
    nextLabel.innerHTML = 'Continuar ‚Üí';
  }
  updateProgress();
}

/* ---------- Validation (inline) ---------- */
function validateStep(){
  const stepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
  if(!stepEl) return true;
  const requiredInputs = stepEl.querySelectorAll('input[required],textarea[required]');
  // handle radio group specially
  if(currentStep === 2){
    const checked = document.querySelector('input[name="attending"]:checked');
    if(!checked){
      $('#errorAttending').textContent = 'Por favor, escolhe uma op√ß√£o.'; $('#errorAttending').style.display = 'block';
      return false;
    } else {
      $('#errorAttending').style.display = 'none';
    }
  }
  for(const input of requiredInputs){
    if(input.type !== 'radio' && !input.value.trim()){
      const id = input.id || '';
      if(id === 'name'){
        $('#errorName').textContent = 'Por favor, escreve o teu nome.'; $('#errorName').style.display = 'block';
        input.focus();
        return false;
      }
    }
  }
  // clear errors
  $('#errorName') && ($('#errorName').style.display = 'none');
  return true;
}

/* ---------- Navigation ---------- */
function nextStep(){
  // Validate
  if(!validateStep()) return;
  // Special case: se escolheu "n√£o" no step 2, ir directo para mensagem
  if(currentStep === 2){
    const attendingNo = !!$('#attending-no') && $('#attending-no').checked;
    if(attendingNo){
      currentStep = 4;
      // adaptar texto do passo 4
      $('#step4Title').textContent = 'üò¢ Vais fazer falta!';
      $('#step4Subtitle').textContent = 'Se quiseres, deixa-nos saber porqu√™ (opcional)';
      showStep(currentStep); updateProgress();
      return;
    }
  }

  if(currentStep < totalSteps){
    currentStep++;
    showStep(currentStep);
  } else {
    submitForm();
  }
  // small UX: announce greeting when user completes name
  if(currentStep === 2){
    const name = ($('#name') && $('#name').value.trim()) || '';
    if(name) personalizeGreeting(name);
  }
}
function prevStep(){
  // if foi para 4 por "n√£o", voltar para 2
  const attendingNo = !!$('#attending-no') && $('#attending-no').checked;
  if(currentStep === 4 && attendingNo){
    currentStep = 2;
    $('#step4Title').textContent = 'üíå Deixa uma Mensagem';
    $('#step4Subtitle').textContent = 'Partilha os teus desejos (opcional)';
    showStep(currentStep);
    return;
  }
  if(currentStep > 1){
    currentStep--;
    showStep(currentStep);
  }
}

/* ---------- Personalize greeting ---------- */
function personalizeGreeting(name){
  const heroTitle = $('#heroTitle');
  if(heroTitle) heroTitle.textContent = `Ol√°, ${name}!`;
  // tiny sparkle effect
  const subtitle = $('#heroSubtitle');
  if(subtitle) subtitle.textContent = 'Que bom ver-te aqui!';
}

/* ---------- Confetti (optimized) ---------- */
let confettiTimeouts = [];
function triggerConfetti({count=120,burst=false} = {}){
  // cleanup timeouts if many triggers
  confettiTimeouts.forEach(t=>clearTimeout(t));
  confettiTimeouts = [];
  const colors = ['#ff6b6b','#4ecdc4','#ffe66d','#a8e6cf','#ffd93d','#ff8a80','#b39ddb'];
  const bodyW = window.innerWidth;
  const bodyH = window.innerHeight;
  const spawn = (i) => {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const size = Math.random()*12 + 6;
    el.style.width = el.style.height = size + 'px';
    el.style.left = (Math.random()*bodyW) + 'px';
    el.style.top = '-20px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.borderRadius = (Math.random()>0.5)?'50%':'4px';
    el.style.zIndex = 9999;
    el.style.position = 'fixed';
    el.style.pointerEvents = 'none';
    el.style.opacity = 1;
    const duration = 2500 + Math.random()*1200;
    el.style.transition = `transform ${duration}ms cubic-bezier(.2,.9,.3,1), opacity ${duration+200}ms linear`;
    document.body.appendChild(el);
    requestAnimationFrame(()=>{
      const tx = (Math.random()-0.5)* (burst? bodyW : 200);
      const ty = bodyH + 200 + Math.random()*200;
      const rot = (Math.random()*720) * (Math.random()>0.5?1:-1);
      el.style.transform = `translate(${tx}px, ${ty}px) rotate(${rot}deg)`;
      el.style.opacity = 0;
    });
    setTimeout(()=> el.remove(), duration+300);
  };
  for(let i=0;i<count;i++){
    const t = setTimeout(()=> spawn(i), burst ? (i*4) : (i*8));
    confettiTimeouts.push(t);
  }
}

/* ---------- Fireworks (simple visual burst) ---------- */
function triggerFireworks(){
  const colors = ['#ff6b6b','#4ecdc4','#ffe66d','#a8e6cf','#ffd93d','#ff8a80'];
  const bursts = 5;
  for(let i=0;i<bursts;i++){
    setTimeout(()=>{
      const x = Math.random()*window.innerWidth;
      const y = Math.random()*window.innerHeight*0.45;
      createFirework(x,y,colors[Math.floor(Math.random()*colors.length)]);
    }, i*350);
  }
}
function createFirework(x,y,color){
  const container = document.createElement('div');
  container.style.position='fixed';container.style.left=`${x}px`;container.style.top=`${y}px`;container.style.pointerEvents='none';container.style.zIndex=9998;
  document.body.appendChild(container);
  const particles = 18 + Math.floor(Math.random()*18);
  for(let i=0;i<particles;i++){
    const p = document.createElement('div');
    p.style.position='absolute';p.style.width='6px';p.style.height='6px';p.style.borderRadius='50%';
    p.style.background = color; p.style.left='0px'; p.style.top='0px'; p.style.opacity='1';
    const angle = (Math.PI*2*i)/particles;
    const dist = 60 + Math.random()*120;
    const tx = Math.cos(angle)*dist;
    const ty = Math.sin(angle)*dist;
    p.style.transition = `transform 900ms cubic-bezier(.2,.8,.2,1), opacity 900ms linear`;
    container.appendChild(p);
    requestAnimationFrame(()=> {
      p.style.transform = `translate(${tx}px, ${ty}px)`;
      p.style.opacity = 0;
    });
  }
  setTimeout(()=> container.remove(), 1100);
}

/* ---------- Balloon pop ---------- */
function popBalloon(el){
  el.style.transition = 'transform .28s ease, opacity .28s ease';
  el.style.transform = 'scale(0) rotate(-30deg)';
  el.style.opacity = 0;
  const rect = el.getBoundingClientRect();
  createFirework(rect.left + rect.width/2, rect.top + rect.height/2, '#ff6b6b');
  setTimeout(()=> {
    el.style.transform = '';
    el.style.opacity = '';
  }, 2500);
}

/* ---------- Keyboard shortcuts ---------- */
document.addEventListener('keydown', (e)=>{
  // prevent effect when typing in inputs
  if(e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
  if(envelopeOpened && !$('#successScreen').classList.contains('show')){
    if(e.key === 'ArrowRight') nextStep();
    if(e.key === 'ArrowLeft') prevStep();
    if(e.key === 'Enter') nextStep();
  }
  if(e.key.toLowerCase() === 'c') triggerConfetti({count:40});
  if(e.key.toLowerCase() === 'f') triggerFireworks();
});

/* ---------- Submit form (with Firebase) ---------- */
let dbInstance = null;
function initFirebase(){
  if(window.firebase && !dbInstance){
    try{
      firebase.initializeApp(dbConfig);
      dbInstance = firebase.firestore();
    }catch(err){
      console.warn('Firebase init error (provavelmente j√° inicializado).', err);
    }
  }
}

/* spinner helper */
function setSending(sending){
  const nextBtn = $('#nextBtn');
  if(sending){
    nextBtn.disabled = true;
    $('#nextLabel').innerHTML = '<span class="spinner" aria-hidden="true"></span> A enviar...';
  } else {
    nextBtn.disabled = false;
    $('#nextLabel').innerHTML = (currentStep===totalSteps) ? 'üéâ Confirmar' : 'Continuar ‚Üí';
  }
}

function submitForm(){
  // final validation
  if(!validateStep()) return;
  // collect
  const name = ($('#name') && $('#name').value.trim()) || '';
  const attending = document.querySelector('input[name="attending"]:checked') ? document.querySelector('input[name="attending"]:checked').value : '';
  const music = ($('#music') && $('#music').value.trim()) || '';
  const message = ($('#message') && $('#message').value.trim()) || '';

  // small inline visual check
  if(!name){
    $('#errorName').textContent = 'Por favor, escreve o teu nome.'; $('#errorName').style.display='block'; $('#name').focus(); return;
  }
  if(!attending){
    $('#errorAttending').textContent = 'Por favor, diz se vens.'; $('#errorAttending').style.display='block'; return;
  }

  // show spinner
  setSending(true);

  // prepare payload
  const payload = {
    name, attending, music, message, createdAt: (dbInstance ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString())
  };

  // if Firestore available, save; otherwise graceful fallback (simulated save)
  if(dbInstance){
    dbInstance.collection('guests').add(payload)
      .then(()=> {
        showSuccess(attending);
      })
      .catch(err => {
        console.error('Erro enviar:', err);
        setSending(false);
        // shake button + message
        const btn = $('#nextBtn');
        btn.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}], {duration:400,iterations:1});
        alert('Erro ao enviar. Tenta novamente, por favor.');
      });
  } else {
    // no DB (offline) - simulate success after 900ms
    setTimeout(()=> {
      setSending(false);
      showSuccess(attending);
    }, 900);
  }
}

/* ---------- Success UI ---------- */
function showSuccess(attending){
  // hide form steps & nav
  $$('.form-step').forEach(s => s.style.display = 'none');
  $('#formNav').style.display = 'none';
  $('#successScreen').classList.add('show');
  $('#successScreen').setAttribute('aria-hidden','false');

  if(attending === 'no'){
    $('#successEmoji').textContent = 'üò¢';
    $('#successTitle').textContent = 'Que Pena...';
    $('#successMessage').textContent = 'Vais fazer muita falta na festa. Obrigado por responderes.';
    $('#successInfo').innerHTML = '<strong>üíî Obrigado</strong><p>Fica bem!</p>';
  } else {
    $('#successEmoji').textContent = 'üéâ';
    $('#successTitle').textContent = 'Confirmado!';
    $('#successMessage').textContent = 'A tua resposta foi registada com sucesso. Mal podemos esperar para celebrar contigo!';
    $('#successInfo').innerHTML = '<strong>‚úÖ Resposta Guardada</strong><p>Vemo-nos dia 22 de Novembro √†s 16:00!</p>';
    // celebration
    triggerConfetti({count:120,burst:true});
    setTimeout(()=>triggerFireworks(),400);
  }
}

/* ---------- Init on DOMContentLoaded ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // hide loading
  setTimeout(()=> {
    $('#loadingScreen').classList.add('hidden');
  }, 650);

  // ensure event card visible
  setTimeout(()=> $('#eventCard').classList.add('revealed'), 300);

  // progress and buttons
  updateProgress();
  showStep(currentStep);

  // focus handling for inputs: small UX
  $('#name').addEventListener('input', ()=> {
    const val = $('#name').value.trim();
    if(val) $('#errorName').style.display = 'none';
  });
  $$('#rsvpSection .radio-option input').forEach(r => {
    r.addEventListener('change', ()=> $('#errorAttending').style.display = 'none');
  });

  // subtle keyboard hint: open envelope after 5s if user didn't interact
  setTimeout(()=>{
    if(!envelopeOpened) openEnvelope();
  }, 5000);
});

/* ---------- accessibility: stop heavy animations on reduced-motion ---------- */
// handled by CSS media query already
</script>
</body>
</html>
